# ReadIn AI Nginx Configuration
# Location on server: /etc/nginx/sites-available/readin-ai
# To apply: sudo cp deployment/nginx.conf /etc/nginx/sites-available/readin-ai && sudo nginx -t && sudo systemctl reload nginx

# HTTP to HTTPS redirect
server {
    listen 80;
    server_name getreadin.us www.getreadin.us;
    return 301 https://www.getreadin.us$request_uri;
}

# Redirect non-www to www
server {
    listen 443 ssl http2;
    server_name getreadin.us;

    ssl_certificate /etc/letsencrypt/live/getreadin.us/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/getreadin.us/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    return 301 https://www.getreadin.us$request_uri;
}

# Main HTTPS server (www)
server {
    listen 443 ssl http2;
    server_name www.getreadin.us;

    ssl_certificate /etc/letsencrypt/live/getreadin.us/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/getreadin.us/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    location /downloads/ {
        alias /home/ubuntu/readin-ai/downloads/;
        autoindex off;

        # Force download with proper headers
        add_header Content-Disposition 'attachment' always;
        add_header X-Content-Type-Options 'nosniff' always;
        add_header Cache-Control 'no-cache' always;

        # Set correct MIME types
        types {
            application/zip                      zip;
            application/x-apple-diskimage        dmg;
            application/x-executable             AppImage;
            application/octet-stream             exe;
        }
    }

    # Cache Next.js static files (immutable)
    location /_next/static/ {
        proxy_pass http://127.0.0.1:3001/_next/static/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;

        # Long-term caching for static assets
        add_header Cache-Control 'public, max-age=31536000, immutable';
        add_header X-Content-Type-Options 'nosniff';
    }

    # Cache static images and fonts
    location ~* \.(ico|jpg|jpeg|png|gif|svg|webp|avif|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;

        # Cache for 30 days
        add_header Cache-Control 'public, max-age=2592000';
        add_header X-Content-Type-Options 'nosniff';
    }

    location /api/ {
        proxy_pass http://127.0.0.1:8001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    location /auth/ {
        proxy_pass http://127.0.0.1:8001/auth/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /user/ {
        proxy_pass http://127.0.0.1:8001/user/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /health {
        proxy_pass http://127.0.0.1:8001/health;
    }

    location /docs {
        proxy_pass http://127.0.0.1:8001/docs;
    }

    location /openapi.json {
        proxy_pass http://127.0.0.1:8001/openapi.json;
    }

    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}

# Keep port 7500 as fallback (direct IP access)
server {
    listen 7500;
    server_name _;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 1000;
    gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

    location /downloads/ {
        alias /home/ubuntu/readin-ai/downloads/;
        autoindex off;
        add_header Content-Disposition 'attachment' always;
    }

    # Cache Next.js static files
    location /_next/static/ {
        proxy_pass http://127.0.0.1:3001/_next/static/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        add_header Cache-Control 'public, max-age=31536000, immutable';
    }

    location /api/ {
        proxy_pass http://127.0.0.1:8001/api/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    location /auth/ {
        proxy_pass http://127.0.0.1:8001/auth/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /user/ {
        proxy_pass http://127.0.0.1:8001/user/;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /health {
        proxy_pass http://127.0.0.1:8001/health;
    }

    location /docs {
        proxy_pass http://127.0.0.1:8001/docs;
    }

    location /openapi.json {
        proxy_pass http://127.0.0.1:8001/openapi.json;
    }

    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }
}
