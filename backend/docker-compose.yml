# ReadIn AI Backend - Docker Compose
# Usage: docker-compose up -d

version: '3.8'

services:
  # Redis - Required for Celery task queue and caching
  redis:
    image: redis:7-alpine
    container_name: readin-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # PostgreSQL Database
  db:
    image: postgres:15-alpine
    container_name: readin-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: readin
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: readin_ai
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U readin -d readin_ai"]
      interval: 10s
      timeout: 5s
      retries: 5

  # FastAPI Backend
  api:
    build: .
    container_name: readin-api
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://readin:${DB_PASSWORD}@db:5432/readin_ai
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET: ${JWT_SECRET}
      JWT_ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_DAYS: 30
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      STRIPE_PRICE_MONTHLY: ${STRIPE_PRICE_MONTHLY}
      PAYSTACK_SECRET_KEY: ${PAYSTACK_SECRET_KEY}
      PAYSTACK_PUBLIC_KEY: ${PAYSTACK_PUBLIC_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY}
      TRIAL_DAYS: 7
      TRIAL_DAILY_LIMIT: 10
      APP_NAME: ReadIn AI
    ports:
      - "8000:8000"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    healthcheck:
      test: ["CMD", "python", "-c", "import httpx; httpx.get('http://localhost:8000/health')"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Celery Worker - Background task processing (summaries, emails)
  celery-worker:
    build: .
    container_name: readin-celery-worker
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://readin:${DB_PASSWORD}@db:5432/readin_ai
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
      CELERY_RESULT_BACKEND: redis://redis:6379/0
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY}
      APP_NAME: ReadIn AI
    command: celery -A workers.celery_app worker --loglevel=info --concurrency=2
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL

  # Celery Beat - Scheduled tasks (optional)
  celery-beat:
    build: .
    container_name: readin-celery-beat
    restart: unless-stopped
    depends_on:
      - redis
      - celery-worker
    environment:
      REDIS_URL: redis://redis:6379/0
      CELERY_BROKER_URL: redis://redis:6379/0
    command: celery -A workers.celery_app beat --loglevel=info
    profiles:
      - production

  # Nginx Reverse Proxy (optional, for production)
  nginx:
    image: nginx:alpine
    container_name: readin-nginx
    restart: unless-stopped
    depends_on:
      - api
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    profiles:
      - production

volumes:
  postgres_data:
  redis_data:
